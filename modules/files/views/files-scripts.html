<script>
let currentPath = '/';
let selectedItemForRename = null;
let config = window.fileExplorerConfig || { rootPath: "/", title: "File Explorer" };

// Initialize
async function init() {
  // Immer mit dem konfigurierten Root-Pfad starten
  currentPath = config.rootPath;
  
  // Titel setzen
  document.getElementById('pageTitle').textContent = config.title;
  
  await loadFiles();
  setupEventListeners();
}

// Setup event listeners using event delegation
function setupEventListeners() {
  // Globaler Click-Handler für alle Aktionen
  document.addEventListener('click', handleGlobalClick);

  // Browser-Navigation (Vor/Zurück)
  window.addEventListener('popstate', async () => {
    const urlParams = new URLSearchParams(window.location.search);
    currentPath = urlParams.get('file') || '/';
    await loadFiles();
  });

  // Form-Handler
  setupFormHandlers();
}

// Zentraler Click-Handler
function handleGlobalClick(e) {
  const target = e.target;
  
  // Finde das nächste Element mit data-action oder data-path
  const actionElement = target.closest('[data-action]');
  const pathElement = target.closest('[data-path]');
  
  if (actionElement) {
    e.preventDefault();
    handleAction(actionElement);
  } else if (pathElement) {
    e.preventDefault();
    handleNavigation(pathElement);
  }
}

// Handler für alle Aktionen
function handleAction(element) {
  const action = element.dataset.action;
  const path = element.dataset.path;
  const name = element.dataset.name;
  
  const actions = {
    delete: () => deleteItem(path),
    rename: () => showRenameDialog(path, name),
    upload: () => showUploadDialog(),
    newFile: () => createNewFile(),
    newFolder: () => createNewFolder()
  };

  if (actions[action]) {
    actions[action]();
  }
}

// Handler für Navigation
function handleNavigation(element) {
  const path = element.dataset.path;
  if (element.dataset.type === 'file') {
    previewFile(path);
  } else {
    navigateTo(path);
  }
}

// Form-Handler Setup
function setupFormHandlers() {
  // Upload Form Handler
  const uploadForm = document.getElementById('uploadForm');
  if (uploadForm) {
    uploadForm.onsubmit = handleUpload;
  }

  // Rename Form Handler
  const renameForm = document.getElementById('renameForm');
  if (renameForm) {
    renameForm.onsubmit = handleRename;
  }
}

// Upload Handler
async function handleUpload(e) {
  e.preventDefault();
  const formData = new FormData(e.target);
  formData.append('path', currentPath);

  try {
    const response = await fetch('/api/files/upload', {
      method: 'POST',
      body: formData
    });

    if (response.ok) {
      closeDialog('uploadDialog');
      loadFiles();
      e.target.reset();
    } else {
      throw new Error('Upload failed');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error uploading files');
  }
}

// Rename Handler
async function handleRename(e) {
  e.preventDefault();
  const newName = document.getElementById('newName').value;
  const dir = selectedItemForRename.split(/[\/\\]/).slice(0, -1).join('\\');
  const newPath = dir + '\\' + newName;

  try {
    const response = await fetch('/api/files/rename', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ oldPath: selectedItemForRename, newPath })
    });

    if (response.ok) {
      closeDialog('renameDialog');
      loadFiles();
    } else {
      throw new Error('Rename failed');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error renaming item');
  }
}

// Load files and directories
async function loadFiles() {
  try {
    const response = await fetch('/api/files/list?path=' + encodeURIComponent(currentPath));
    if (!response.ok) throw new Error('Failed to load directory');
    const data = await response.json();
    if (data.error) {
      alert('Error: ' + data.error);
      // Wenn ein Fehler auftritt, gehe zum übergeordneten Verzeichnis zurück
      if (currentPath !== '/' && !currentPath.endsWith(':\\')) {
        const parentPath = currentPath.split('\\').slice(0, -1).join('\\');
        if (parentPath !== currentPath) {
          currentPath = parentPath || '/';
          await loadFiles();
        }
      }
      return;
    }
    renderPath();
    renderFiles(data);
  } catch (error) {
    console.error('Error:', error);
    alert('Error loading files');
  }
}

// Render path breadcrumb
function renderPath() {
  const parts = [];
  let pathToProcess = currentPath;
  
  // Wenn ein Root-Pfad konfiguriert ist, diesen als Basis verwenden
  if (config.rootPath !== "/") {
    if (currentPath === config.rootPath) {
      pathToProcess = "";
    } else if (currentPath.startsWith(config.rootPath)) {
      pathToProcess = currentPath.slice(config.rootPath.length);
    }
    // Domain-Name als erste Ebene
    parts.push(config.title.replace('Files - ', '')); 
  }
  
  // Restliche Pfadteile hinzufügen
  if (pathToProcess) {
    parts.push(...pathToProcess.split(/[\/\\]/).filter(p => p));
  }
  
  let html = '<a href="#" data-path="' + config.rootPath + '">' + (parts[0] || 'Root') + '</a>';
  let currentPathBuild = config.rootPath;
  
  // Ab dem zweiten Element den Pfad aufbauen
  for (let i = 1; i < parts.length; i++) {
    currentPathBuild = join(currentPathBuild, parts[i]);
    html += ` / <a href="#" data-path="${currentPathBuild}">${parts[i]}</a>`;
  }
  
  document.getElementById('pathBreadcrumb').innerHTML = html;
  document.getElementById('pageTitle').textContent = config.title;
}

// Render files and directories
function renderFiles(items) {
  const tbody = document.getElementById('fileList');
  tbody.innerHTML = '';

  // Parent directory link (..)
  if (currentPath !== '/' && !currentPath.endsWith(':\\')) {
    const parentPath = currentPath.split('\\').slice(0, -1).join('\\') || '/';
    tbody.innerHTML += '<tr class="file-row"><td><i class="mdi mdi-folder file-icon"></i></td>' +
      '<td><a href="#" data-path="' + parentPath + '">..</a></td>' +
      '<td>-</td><td>-</td><td>-</td></tr>';
  }

  items.forEach(item => {
    const isDirectory = item.name.endsWith('/');
    const name = isDirectory ? item.name.slice(0, -1) : item.name;
    const icon = isDirectory ? 'mdi-folder' : 'mdi-file-document';
    
    tbody.innerHTML += '<tr class="file-row"><td><i class="mdi ' + icon + ' file-icon"></i></td><td>' + 
      (isDirectory 
        ? '<a href="#" data-path="' + item.path + '">' + name + '</a>'
        : '<a href="#" data-path="' + item.path + '" data-type="file">' + name + '</a>'
      ) + '</td><td>' + (item.size ? formatFileSize(item.size) : '-') + '</td><td>' + 
      (item.modified ? new Date(item.modified).toLocaleString(undefined, {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit'
      }) : '-') + '</td><td>' +
      '<button class="btn u2-unstyle" data-action="rename" data-path="' + item.path + '" data-name="' + name + '" title="Rename">' +
        '<i class="mdi mdi-rename"></i></button>' + 
      '<button class="btn u2-unstyle" data-action="delete" data-path="' + item.path + '" title="Delete">' +
        '<i class="mdi mdi-delete"></i></button></td></tr>';
  });
}

// File size formatter
function formatFileSize(bytes) {
  const units = ['B', 'KB', 'MB', 'GB', 'TB'];
  let size = bytes;
  let unitIndex = 0;
  
  while (size >= 1024 && unitIndex < units.length - 1) {
    size /= 1024;
    unitIndex++;
  }
  
  return size.toFixed(1) + ' ' + units[unitIndex];
}

// Navigation
function navigateTo(path) {
  // Wenn ein Root-Pfad konfiguriert ist, diesen nicht überschreiten
  if (config.rootPath !== "/" && !path.startsWith(config.rootPath)) {
    currentPath = config.rootPath;
  } else {
    currentPath = path;
  }
  
  // URL aktualisieren ohne Seitenneuladen
  const url = new URL(window.location.href);
  url.searchParams.set('file', currentPath);
  window.history.pushState({}, '', url.toString());
  
  loadFiles();
  document.getElementById('previewTitle').textContent = 'Select a file to preview';
  document.getElementById('fileContent').value = '';
}

// File preview
async function previewFile(path) {
  try {
    const response = await fetch('/api/files/content?path=' + encodeURIComponent(path));
    const content = await response.text();
    document.getElementById('fileContent').value = content;
    document.getElementById('previewTitle').textContent = path.split(/[\/\\]/).pop();
    setupEditor(path);
  } catch (error) {
    console.error('Error:', error);
    alert('Error loading file content');
  }
}

// Set up editor with save functionality
function setupEditor(path) {
  const textarea = document.getElementById('fileContent');
  textarea.onkeydown = async function(e) {
    if (e.key === 's' && (e.ctrlKey || e.metaKey)) {
      e.preventDefault();
      await saveFile(path);
    }
  };
}

// Save file content
async function saveFile(path) {
  try {
    const content = document.getElementById('fileContent').value;
    const response = await fetch('/api/files/content', {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path, content })
    });

    if (response.ok) {
      alert('File saved successfully');
    } else {
      throw new Error('Failed to save file');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error saving file');
  }
}

// Dialog functions
function showDialog(id) {
  document.getElementById(id).showModal();
}

function closeDialog(id) {
  document.getElementById(id).close();
}

function showUploadDialog() {
  showDialog('uploadDialog');
}

function showRenameDialog(path, name) {
  selectedItemForRename = path;
  document.getElementById('newName').value = name;
  showDialog('renameDialog');
}

// File operations
async function createNewFile() {
  const name = prompt('File name:');
  if (!name) return;

  try {
    // Verwende join für korrekte Pfadkonstruktion
    const path = join(currentPath, name);
    if (!path.startsWith(config.rootPath)) {
      throw new Error('Invalid path');
    }

    const response = await fetch('/api/files', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path, type: 'file' })
    });

    if (!response.ok) {
      throw new Error('Failed to create file');
    }
    await loadFiles();
  } catch (error) {
    console.error('Error:', error);
    alert('Error creating file');
  }
}

async function createNewFolder() {
  const name = prompt('Folder name:');
  if (!name) return;

  try {
    // Verwende join für korrekte Pfadkonstruktion
    const path = join(currentPath, name);
    if (!path.startsWith(config.rootPath)) {
      throw new Error('Invalid path');
    }

    const response = await fetch('/api/files', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path, type: 'directory' })
    });

    if (!response.ok) {
      throw new Error('Failed to create folder');
    }
    await loadFiles();
  } catch (error) {
    console.error('Error:', error);
    alert('Error creating folder');
  }
}

async function deleteItem(path) {
  if (!confirm('Are you sure you want to delete this item?')) return;

  try {
    const response = await fetch('/api/files', {
      method: 'DELETE',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ path })
    });

    if (response.ok) {
      loadFiles();
    } else {
      alert('Error deleting item');
    }
  } catch (error) {
    console.error('Error:', error);
    alert('Error deleting item');
  }
}

// Hilfsfunktion zum Verbinden von Pfaden
function join(...parts) {
  // Filtere leere Teile heraus und verbinde mit \
  return parts.filter(part => part).join('\\').replace(/\\+/g, '\\');
}

// Initial load
init();
</script>